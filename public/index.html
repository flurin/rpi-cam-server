<!doctype html>
<html>
  <head>
    <title>RPI Cam Controller</title>
    <script src="/javascripts/binary.js"></script>
    <script src="/javascripts/canvas_effects.js"></script>
    
  </head>
  <body>
    
    <div class="view">
      <canvas class="view__canvas" id="canvas" width="1024" height="768">
      </canvas>

      <div class="view__controls">
        <button id="btn_start">Start!</button>
        <button id="btn_stop">Stop!</button>
        <button id="btn_test">Test!</button>
      </div>
    </div>

    
    <script>
      var canvasEl = document.getElementById("canvas");
      var ctx = canvasEl.getContext("2d");

      var fx = new CanvasEffects(canvasEl, {useWorker: false});
      
      document.getElementById("btn_start").addEventListener("click", function(){
        var request = new XMLHttpRequest();
        request.open('GET', '/camera/start', true);
        request.send();
      });

      document.getElementById("btn_stop").addEventListener("click", function(){
        var request = new XMLHttpRequest();
        request.open('GET', '/camera/stop', true);
        request.send();
      });

      document.getElementById("btn_test").addEventListener("click", function(){
        var request = new XMLHttpRequest();
        request.open('GET', '/camera/test', true);
        request.send();
      });

      var applyEffects = function(){
        
      };

      var handleMessage = function(data){
        console.log("DATA", data);

        canvasEl.width = canvasEl.width;
        ctx.font = "bold 16px Arial";
        ctx.fillText(data.message, 10, 50);
      };

      var handleImage = function(data){
        console.log("DRAW!");

        var img = new Image();
        img.src = (window.URL || window.webkitURL).createObjectURL(new Blob(data));
        img.onload = function(){
          canvasEl.width = canvasEl.width;
          ctx.save();
          ctx.rotate(Math.PI);
          ctx.drawImage(img, -1 * canvasEl.width, -1 * canvasEl.height);
          applyEffects();
        }
      };

      var client = new BinaryClient('ws://'+window.location.host + '/stream');
      client.on('stream', function(stream, meta){   
        console.log(stream, meta);
        var parts = [];
        stream.on('data', function(data){
          console.log("DATA", meta);
          if(meta.type === "image"){
            parts.push(data);  
          } else {
            handleMessage(data);
          }
        });

        stream.on('end', function(){
          console.log("END", meta);
          if(meta.type === "image"){
            handleImage(parts);
          } 
        });

        stream.on("error", function(error){
          console.log("ERROR", error);
        })
      });      
    </script>
  </body>
</html>